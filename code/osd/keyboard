#!/usr/bin/env bash

# Keyboard layout helper for Hyprland + AGS OSD
# 1. Switches the layout using hyprctl
# 2. Queries the new layout
# 3. Sends it to AGS via `ags request osd layout <layout>`

KEYBOARD_DEVICE="at-translated-set-2-keyboard"

get_keyboard_layout() {
    hyprctl devices -j |
        jq -r ".keyboards[] | select(.name == \"$KEYBOARD_DEVICE\") | .active_keymap" 2>/dev/null || echo "Unknown"
}

# Switch layout
hyprctl switchxkblayout "$KEYBOARD_DEVICE" next >/dev/null 2>&1

# Read new layout
layout_full="$(get_keyboard_layout)"

# Shrink to something nicer if possible (e.g. "English (US)" -> "US")
layout_short="${layout_full##* }"
[ -z "$layout_short" ] && layout_short="$layout_full"

# Notify AGS OSD (ignore errors if AGS is not running)
ags request osd layout "$layout_short" >/dev/null 2>&1 || true
