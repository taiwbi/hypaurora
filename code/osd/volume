#!/usr/bin/env bash

# Get current volume (0–100)
get_volume() {
    pactl get-sink-volume @DEFAULT_SINK@ | grep -o '[0-9]*%' | head -1 | tr -d '%'
}

# Get current mute state (yes|no)
get_mute_state() {
    pactl get-sink-mute @DEFAULT_SINK@ | grep -o 'yes\|no'
}

# Set volume with bounds checking
set_volume() {
    local change="$1"
    local current_volume new_volume

    current_volume=$(get_volume)

    if [[ "$change" =~ ^\+[0-9]+$ ]]; then
        local increase=${change#+}
        new_volume=$((current_volume + increase))
        [ "$new_volume" -gt 100 ] && new_volume=100
        pactl set-sink-volume @DEFAULT_SINK@ "${new_volume}%"
    elif [[ "$change" =~ ^-[0-9]+$ ]]; then
        local decrease=${change#-}
        new_volume=$((current_volume - decrease))
        [ "$new_volume" -lt 0 ] && new_volume=0
        pactl set-sink-volume @DEFAULT_SINK@ "${new_volume}%"
    fi
}

toggle_mute() {
    pactl set-sink-mute @DEFAULT_SINK@ toggle
}

send_ags_osd() {
    local volume muted level muted_flag
    volume=$(get_volume)
    muted=$(get_mute_state)

    # Normalize volume 0–1 for AGS
    level=$(awk -v v="$volume" 'BEGIN { printf "%.2f", v/100.0 }')

    muted_flag="0"
    [ "$muted" = "yes" ] && muted_flag="1"

    ags request osd volume "$level" "$muted_flag" >/dev/null 2>&1 || true
}

if [ $# -lt 1 ]; then
    exit 1
fi

case "$1" in
    --raise)
        [ -z "$2" ] && exit 1
        set_volume "+$2"
        ;;
    --lower)
        [ -z "$2" ] && exit 1
        set_volume "-$2"
        ;;
    --toggle-mute)
        toggle_mute
        ;;
    *)
        exit 1
        ;;
esac

send_ags_osd
