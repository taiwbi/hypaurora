#!/usr/bin/env bash

# Simple brightness helper for Hyprland that:
# 1. Adjusts brightness via brightnessctl
# 2. Notifies AGS OSD via `ags request osd brightness <level0to1>`

get_brightness() {
    local max_brightness current_brightness
    max_brightness=$(brightnessctl max)
    current_brightness=$(brightnessctl get)
    # Return percentage 0-100
    echo $((current_brightness * 100 / max_brightness))
}

set_brightness() {
    local change="$1"
    local current_brightness new_brightness

    current_brightness=$(get_brightness)

    if [[ "$change" =~ ^\+[0-9]+$ ]]; then
        local increase=${change#+}
        new_brightness=$((current_brightness + increase))
        [ "$new_brightness" -gt 100 ] && new_brightness=100
        brightnessctl set "${new_brightness}%" >/dev/null
    elif [[ "$change" =~ ^-[0-9]+$ ]]; then
        local decrease=${change#-}
        new_brightness=$((current_brightness - decrease))
        [ "$new_brightness" -lt 5 ] && new_brightness=5
        brightnessctl set "${new_brightness}%" >/dev/null
    fi
}

send_ags_osd() {
    # Compute normalized 0-1 level and send to AGS
    local percent level
    percent=$(get_brightness)
    level=$(awk "BEGIN { printf \"%.2f\", $percent/100 }")
    ags request osd brightness "$level" >/dev/null 2>&1 || true
}

if [ $# -lt 2 ]; then
    exit 1
fi

case "$1" in
    --raise)
        set_brightness "+$2"
        ;;
    --lower)
        set_brightness "-$2"
        ;;
    *)
        exit 1
        ;;
esac

send_ags_osd
