set_proxy() {
    # Set proxy based on GNOME settings (supports HTTP, HTTPS, and SOCKS)
    
    # Check if gsettings command exists
    if ! command -v gsettings > /dev/null; then
        return 1
    fi

    # Get the proxy mode, remove single quotes, suppress stderr for schema errors
    local PROXY_MODE
    PROXY_MODE=$(gsettings get org.gnome.system.proxy mode 2>/dev/null | sed "s/'//g")
    
    # Check if gsettings command succeeded (schema exists)
    if [[ $? -ne 0 ]]; then
        return 1
    fi

    if [[ "$PROXY_MODE" == "manual" ]]; then
        # Get HTTP proxy settings
        local HTTP_HOST HTTP_PORT
        HTTP_HOST=$(gsettings get org.gnome.system.proxy.http host 2>/dev/null | sed "s/'//g")
        HTTP_PORT=$(gsettings get org.gnome.system.proxy.http port 2>/dev/null)

        # Get HTTPS proxy settings
        local HTTPS_HOST HTTPS_PORT
        HTTPS_HOST=$(gsettings get org.gnome.system.proxy.https host 2>/dev/null | sed "s/'//g")
        HTTPS_PORT=$(gsettings get org.gnome.system.proxy.https port 2>/dev/null)

        # Get SOCKS proxy settings
        local SOCKS_HOST SOCKS_PORT
        SOCKS_HOST=$(gsettings get org.gnome.system.proxy.socks host 2>/dev/null | sed "s/'//g")
        SOCKS_PORT=$(gsettings get org.gnome.system.proxy.socks port 2>/dev/null)

        # Get ignore hosts list
        local IGNORE_HOSTS
        IGNORE_HOSTS=$(gsettings get org.gnome.system.proxy ignore-hosts 2>/dev/null | sed "s/\[//g; s/\]//g; s/'//g")

        # Set HTTP proxy if configured
        if [[ $? -eq 0 && -n "$HTTP_HOST" && "$HTTP_PORT" -gt 0 ]]; then
            export http_proxy="http://$HTTP_HOST:$HTTP_PORT"
            export HTTP_PROXY="http://$HTTP_HOST:$HTTP_PORT"
        else
            unset http_proxy
            unset HTTP_PROXY
        fi

        # Set HTTPS proxy if configured
        if [[ $? -eq 0 && -n "$HTTPS_HOST" && "$HTTPS_PORT" -gt 0 ]]; then
            export https_proxy="http://$HTTPS_HOST:$HTTPS_PORT"
            export HTTPS_PROXY="http://$HTTPS_HOST:$HTTPS_PORT"
        else
            unset https_proxy
            unset HTTPS_PROXY
        fi

        # Set SOCKS proxy if configured
        if [[ $? -eq 0 && -n "$SOCKS_HOST" && "$SOCKS_PORT" -gt 0 ]]; then
            export all_proxy="socks5://$SOCKS_HOST:$SOCKS_PORT"
            export ALL_PROXY="socks5://$SOCKS_HOST:$SOCKS_PORT"
        else
            unset all_proxy
            unset ALL_PROXY
        fi

        # Set no_proxy if ignore hosts are configured
        if [[ -n "$IGNORE_HOSTS" ]]; then
            export no_proxy="$IGNORE_HOSTS"
            export NO_PROXY="$IGNORE_HOSTS"
        else
            unset no_proxy
            unset NO_PROXY
        fi

    else
        # Unset all proxy variables if not in manual mode
        unset http_proxy
        unset HTTP_PROXY
        unset https_proxy
        unset HTTPS_PROXY
        unset all_proxy
        unset ALL_PROXY
        unset no_proxy
        unset NO_PROXY
    fi
}
