#!/usr/bin/env bash

# Get raw list, filter out hidden SSIDs (lines starting with a colon),
# escape colons in SSIDs, and then use awk to build JSON.
raw_list=$(nmcli -t -f SSID,IN-USE,SIGNAL,SECURITY dev wifi list | grep -v '^:' | sed 's/\\:/:/g')

json_list=$(echo "$raw_list" | awk -F: 'BEGIN {
    printf "["
    sep=""
}
{
    ssid=$1
    active=($2 == "*") ? "true" : "false"
    signal=$3
    secure=($4 != "" && $4 != "--") ? "true" : "false"

    gsub(/"/, "\\\"", ssid) # Escape quotes in SSID

    printf "%s\n  {\"ssid\": \"%s\", \"active\": %s, \"signal\": %s, \"secure\": %s}", sep, ssid, active, signal, secure
    sep=","
}
END {
    print "\n]"
}')

echo "$json_list"
