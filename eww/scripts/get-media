#!/usr/bin/env bash

# Function to get metadata if a player is running
get_metadata() {
    if playerctl status &>/dev/null; then
        # Get shuffle status separately and convert to boolean
        shuffle_status=$(playerctl shuffle 2>/dev/null)
        if [ "$shuffle_status" = "On" ]; then
            shuffle_bool="true"
        else
            shuffle_bool="false"
        fi
        
        # Get metadata
        metadata_json=$(playerctl metadata --format '{"title": "{{xesam:title}}","artist": "{{xesam:artist}}","status": "{{status}}","loop": "{{loop}}","shuffle": '"$shuffle_bool"',"artUrl": "{{mpris:artUrl}}"}')

        # Remove first occurrence of file:// from artUrl if present
        metadata_json=$(echo "$metadata_json" | sed 's|"artUrl": "file://|"artUrl": "|')

        echo "$metadata_json"
    else
        # Output an empty JSON object if no player is active
        echo '{}'
    fi
}

# Store previous state to detect changes
previous_state=""

# Initial output
current_state=$(get_metadata)
echo "$current_state"
previous_state="$current_state"

# Poll for changes
while true; do
    current_state=$(get_metadata)
    if [ "$current_state" != "$previous_state" ]; then
        echo "$current_state"
        previous_state="$current_state"
    fi
    sleep 0.6
done
