#!/usr/bin/env bash

# Check for --complete argument
COMPLETE_MODE=false
if [[ "$1" == "--complete" ]]; then
    COMPLETE_MODE=true
fi

# Function to format SSID to exactly 9 characters
format_ssid() {
    local ssid="$1"
    local length=${#ssid}
    
    if [ $length -gt 6 ]; then
        # Truncate to 6 characters and add "..."
        echo "${ssid:0:6}..."
    else
        # Pad with spaces to reach 9 characters
        printf "%-9s" "$ssid"
    fi
}

# Function to get current SSID
get_current_ssid() {
    local ssid=$(nmcli -t -f ACTIVE,SSID dev wifi | grep '^yes' | cut -d: -f2)
    if [ -n "$ssid" ]; then
        if [ "$COMPLETE_MODE" = true ]; then
            echo "$ssid"
        else
            format_ssid "$ssid"
        fi
    else
        if [ "$COMPLETE_MODE" = true ]; then
            echo "Disconnected"
        else
            format_ssid "Discon..."
        fi
    fi
}

# Print current SSID
echo "$(get_current_ssid)"

# Monitor using nmcli monitor
last_ssid=$(get_current_ssid)

nmcli monitor 2>/dev/null | while read -r line; do
    if [[ "$line" == *"connectivity"* ]] || [[ "$line" == *"state changed"* ]] || [[ "$line" == *"wifi"* ]]; then
        sleep 0.5
        current_ssid=$(get_current_ssid)
        
        if [ "$current_ssid" != "$last_ssid" ]; then
            echo "$current_ssid"
            last_ssid="$current_ssid"
        fi
    fi
done
